#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# HOOK PRE-COMMIT - Validation des templates et de l'index
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

echo "ğŸ” VÃ©rification des templates et de l'index..."

# VÃ©rifier si des fichiers templates ou l'index ont Ã©tÃ© modifiÃ©s
TEMPLATES_CHANGED=$(git diff --cached --name-only | grep -E "shared/data/exercises/.*\.json$" || true)
INDEX_CHANGED=$(git diff --cached --name-only | grep -E "shared/data/competenceIndex\.js$" || true)
GENERATOR_CHANGED=$(git diff --cached --name-only | grep -E "scripts/generate-competence-index\.js$" || true)

# Si des templates ont Ã©tÃ© modifiÃ©s mais pas l'index, rÃ©gÃ©nÃ©rer
if [ -n "$TEMPLATES_CHANGED" ] && [ -z "$INDEX_CHANGED" ]; then
    echo "ğŸ“ Templates modifiÃ©s dÃ©tectÃ©s:"
    echo "$TEMPLATES_CHANGED" | sed 's/^/   /'
    echo ""
    echo "ğŸ”§ RÃ©gÃ©nÃ©ration de l'index..."
    
    node scripts/generate-competence-index.js
    
    if [ $? -ne 0 ]; then
        echo "âŒ Ã‰chec de la rÃ©gÃ©nÃ©ration de l'index"
        exit 1
    fi
    
    # Ajouter l'index gÃ©nÃ©rÃ© au commit
    git add shared/data/competenceIndex.js
    echo "âœ… Index rÃ©gÃ©nÃ©rÃ© et ajoutÃ© au commit"
fi

# Valider l'index
echo ""
echo "ğŸ” Validation de l'index..."
node scripts/validate-competence-index.js

EXIT_CODE=$?

if [ $EXIT_CODE -eq 1 ]; then
    echo ""
    echo "âŒ COMMIT BLOQUÃ‰ - Erreurs critiques dÃ©tectÃ©es"
    echo "   Corrigez les erreurs avant de committer."
    echo "   ExÃ©cutez: node scripts/validate-competence-index.js --verbose"
    exit 1
elif [ $EXIT_CODE -eq 2 ]; then
    echo ""
    echo "âš ï¸  Warnings dÃ©tectÃ©s mais commit autorisÃ©"
fi

echo ""
echo "âœ… Validation terminÃ©e"
exit 0
